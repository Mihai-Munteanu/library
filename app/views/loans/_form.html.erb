<%= form_with(model: loan, class: "contents") do |form| %>
  <% if loan.errors.any? %>
    <div id="error_explanation" class="bg-red-50 text-red-500 px-3 py-2 font-medium rounded-md mt-3 mb-4">
      <h2><%= pluralize(loan.errors.count, "error") %> prohibited this loan from being saved:</h2>

      <ul class="list-disc ml-6 mt-2">
        <% loan.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-4">
    <%= form.label :member_id, class: "block text-sm font-medium text-gray-700 mb-2" do %>
      Member <span class="text-red-500">*</span>
    <% end %>
    <% member_id_has_error = loan.errors[:member_id].any? || (loan.errors.any? && loan.member_id.blank?) %>
    <%= form.select :member_id,
        Member.all.map { |m| [m.name, m.id] },
        { prompt: "Select a member", selected: loan.member_id },
        class: "w-full px-3 py-2 border #{member_id_has_error ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white" %>
    <% if loan.errors[:member_id].any? %>
      <p class="mt-1 text-sm text-red-600"><%= loan.errors[:member_id].first %></p>
    <% end %>
  </div>

  <div class="mb-4">
    <%= form.label :book_id, class: "block text-sm font-medium text-gray-700 mb-2" do %>
      Book <span class="text-red-500">*</span>
    <% end %>
    <%
      # For new loans, only show available books
      # For editing or when book_id is preselected, include the current/preselected book even if it's on loan
      available_books = Book.where(status: :available)
      if loan.persisted? && loan.book.present?
        available_books = Book.where(status: :available).or(Book.where(id: loan.book_id))
      elsif loan.book_id.present? && !loan.persisted?
        # Include preselected book even if it's on loan (e.g., from book show page)
        available_books = Book.where(status: :available).or(Book.where(id: loan.book_id))
      end
      book_options = available_books.map { |b| [b.title, b.id] }
    %>
    <% book_id_has_error = loan.errors[:book_id].any? || (loan.errors.any? && loan.book_id.blank?) %>
    <%= form.select :book_id,
        book_options,
        { prompt: "Select an available book", selected: loan.book_id },
        class: "w-full px-3 py-2 border #{book_id_has_error ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white" %>
    <% if loan.errors[:book_id].any? %>
      <p class="mt-1 text-sm text-red-600"><%= loan.errors[:book_id].first %></p>
    <% end %>
  </div>

  <div class="mb-4">
    <%= form.label :start_date, class: "block text-sm font-medium text-gray-700 mb-2" do %>
      Start Date <span class="text-red-500">*</span>
    <% end %>
    <% start_date_has_error = loan.errors[:start_date].any? || (loan.errors.any? && loan.start_date.blank?) %>
    <%= form.date_field :start_date,
        id: "loan_start_date",
        class: "w-full px-3 py-2 border #{start_date_has_error ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition-colors" %>
    <% if loan.errors[:start_date].any? %>
      <p class="mt-1 text-sm text-red-600"><%= loan.errors[:start_date].first %></p>
    <% end %>
  </div>

  <div class="mb-4">
    <%= form.label :due_date, class: "block text-sm font-medium text-gray-700 mb-2" do %>
      Due Date <span class="text-red-500">*</span>
    <% end %>
    <% due_date_has_error = loan.errors[:due_date].any? || (loan.errors.any? && loan.due_date.blank?) %>
    <%= form.date_field :due_date,
        id: "loan_due_date",
        class: "w-full px-3 py-2 border #{due_date_has_error ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition-colors" %>
    <% if loan.errors[:due_date].any? %>
      <p class="mt-1 text-sm text-red-600"><%= loan.errors[:due_date].first %></p>
    <% end %>
  </div>

  <div class="mb-4">
    <%= form.label :notes, class: "block text-sm font-medium text-gray-700 mb-2" do %>
      Notes
    <% end %>
    <%= form.text_area :notes,
        rows: 4,
        class: "w-full px-3 py-2 border #{loan.errors[:notes].any? ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition-colors",
        placeholder: "Optional notes about this loan..." %>
    <% if loan.errors[:notes].any? %>
      <p class="mt-1 text-sm text-red-600"><%= loan.errors[:notes].first %></p>
    <% end %>
  </div>

  <!-- Metadata Section -->
  <div class="mb-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Additional Information</h2>
    <% metadata = loan.metadata || {} %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
      <div>
        <%= form.label :metadata_late_fee, "Late Fee", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= number_field_tag "loan[metadata][late_fee]", metadata["late_fee"],
            placeholder: "0.00",
            step: 0.01,
            min: 0,
            class: "w-full px-3 py-2 border #{loan.errors[:metadata].any? && loan.errors[:metadata].any? { |e| e.include?('late_fee') } ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition-colors" %>
        <% if loan.errors[:metadata].any? { |e| e.include?('late_fee') } %>
          <p class="mt-1 text-sm text-red-600"><%= loan.errors[:metadata].find { |e| e.include?('late_fee') } %></p>
        <% else %>
          <p class="mt-1 text-sm text-gray-500">Late fee amount (if applicable)</p>
        <% end %>
      </div>

      <div>
        <%= form.label :metadata_contact_preference, "Contact Preference", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= select_tag "loan[metadata][contact_preference]",
            options_for_select([
              ["", ""],
              ["Email", "email"],
              ["Phone", "phone"],
              ["SMS", "sms"],
              ["Mail", "mail"]
            ], metadata["contact_preference"]),
            class: "w-full px-3 py-2 border #{loan.errors[:metadata].any? && loan.errors[:metadata].any? { |e| e.include?('contact_preference') } ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition-colors" %>
        <% if loan.errors[:metadata].any? { |e| e.include?('contact_preference') } %>
          <p class="mt-1 text-sm text-red-600"><%= loan.errors[:metadata].find { |e| e.include?('contact_preference') } %></p>
        <% end %>
      </div>

      <div class="md:col-span-2">
        <%= form.label :metadata_special_conditions, "Special Conditions", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= text_area_tag "loan[metadata][special_conditions]", metadata["special_conditions"],
            rows: 3,
            placeholder: "Any special conditions or requirements for this loan...",
            maxlength: 500,
            class: "w-full px-3 py-2 border #{loan.errors[:metadata].any? && loan.errors[:metadata].any? { |e| e.include?('special_conditions') } ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition-colors" %>
        <% if loan.errors[:metadata].any? { |e| e.include?('special_conditions') } %>
          <p class="mt-1 text-sm text-red-600"><%= loan.errors[:metadata].find { |e| e.include?('special_conditions') } %></p>
        <% end %>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const startDateField = document.getElementById('loan_start_date');
      const dueDateField = document.getElementById('loan_due_date');

      if (startDateField && dueDateField) {
        startDateField.addEventListener('change', function() {
          if (this.value) {
            const startDate = new Date(this.value);
            const dueDate = new Date(startDate);
            dueDate.setDate(dueDate.getDate() + 14);

            // Format date as YYYY-MM-DD for the date input
            const year = dueDate.getFullYear();
            const month = String(dueDate.getMonth() + 1).padStart(2, '0');
            const day = String(dueDate.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            // Only update if due date is empty or was previously auto-set
            if (!dueDateField.value || dueDateField.value === dueDateField.dataset.autoSet) {
              dueDateField.value = formattedDate;
              dueDateField.dataset.autoSet = formattedDate;
            }
          }
        });

        // Set initial auto-set flag if due date matches start date + 14 days
        if (startDateField.value && dueDateField.value) {
          const startDate = new Date(startDateField.value);
          const expectedDueDate = new Date(startDate);
          expectedDueDate.setDate(expectedDueDate.getDate() + 14);

          const year = expectedDueDate.getFullYear();
          const month = String(expectedDueDate.getMonth() + 1).padStart(2, '0');
          const day = String(expectedDueDate.getDate()).padStart(2, '0');
          const expectedFormatted = `${year}-${month}-${day}`;

          if (dueDateField.value === expectedFormatted) {
            dueDateField.dataset.autoSet = expectedFormatted;
          }
        }
      }
    });
  </script>

  <div class="mt-6">
    <%= form.submit class: "w-full sm:w-auto rounded-md px-3.5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white inline-block font-medium cursor-pointer transition-colors shadow-md hover:shadow-lg" %>
  </div>
<% end %>
